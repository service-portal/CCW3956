<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <client_script><![CDATA[function($scope, workspaceData) {
	/* widget controller */
	var c = this;
	workspaceData.initRecordWatcher(c.options.table, c.options.filter);
	workspaceData.onDataUpdated(function() {
		c.data.rows = [];
		c.server.update().then(function(data){
			c.data.rows = data.rows;
		});
	});
	
	if (!isConfigured()) {
		// Provide demo data if options.title is empty
		c.options.title = "My active incidents";
		c.options.priority_field = "priority";
		c.options.display_field = "short_description";
		c.data = {
			"fields": {"category": {"label": "Category"}, "opened_by": {"label": "Opened By"}},
			"primaryField": "number",
			"cardFields": "category,opened_by",
			"rows": [
				{"sys_id":"1", "number":"INC0000002","short_description":"Network file shares access issue","category":"Network","priority":"1 - Critical","opened_by":"admin"},
				{"sys_id":"2", "number":"INC0000003","short_description":"I need a mouse","category":"Hardware","priority":"4 - Low","opened_by":"Garfield"}
			]
		}
	} 
	
	c.cardFields = getCardFields(c.data.cardFields, c.data.primaryField);
	
	c.getPrimaryField = function getPrimaryField(row) {
		return row[c.data.primaryField];
	};
	
	function getCardFields(allFields, primaryField) {
		var cardFields = [];
		allFields = allFields.split(",");
		var exclude = [primaryField, c.options.display_field, c.options.priority_field];
		for (var i = allFields.length-1; i>= 0; i--){
			if (exclude.indexOf(allFields[i]) == -1) {
				cardFields.push(allFields[i]);
			}
		}
		return cardFields;
	}
	
	function isConfigured() {
		if (!c.options) {
			return false;
		}
		
		if (typeof c.options.title === "undefined")
			return false;
		
		return true;
	}
	
	c.showFilter = function showFilter(event) {
		var filterModalCtrl;
		event.preventDefault();
		event.stopPropagation();
		
		var unregister = $scope.$on("snfilter:update_query", function(e, query) {
			e.stopPropagation();
			e.preventDefault();
			console.info("new Query", massageEncodedQuery(query));
			// Todo: call webservice for data
			filterModalCtrl.close();
		});
		
		var filterModal = angular.copy(c.data.filterModal);
		filterModal.options.afterOpen = function(ctrl){
			filterModalCtrl = ctrl;
			$scope.$broadcast("snfilter:initialize_query", massageEncodedQuery(c.options.filter));
		};
		
		filterModal.options.afterClose = function() {
			unregister();
			c.filterModal = null;
			filterModalCtrl = null;
		};
		c.filterModal = filterModal;
	}
	
	function massageEncodedQuery(query) {
		return (query) ? query.replace(/CONTAINS/g, "LIKE").replace(/DOES NOT CONTAIN/g, "NOT LIKE") : query;
	}
	
}]]></client_script>
        <controller_as>c</controller_as>
        <css>.fields {
  $dl-horizontal-offset: 120px;
  dt {
    font-weight: normal;
    color: $text-muted;
    float: left;
    width: ($dl-horizontal-offset - 20);
    clear: left;
    text-align: right;
    @include text-overflow;
  }
  dd {
    @include clearfix;
    margin-left: $dl-horizontal-offset;
  }
}</css>
        <data_table>x_snc_reusable_wid_card_list_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list>title,table,view,filter,display_field</field_list>
        <has_preview>true</has_preview>
        <id>card-list</id>
        <internal>false</internal>
        <link/>
        <name>Card List</name>
        <option_schema>[{"hint":"A field that contains a value 1 - 4 to indicate priority.","name":"priority_field","default_value":"priority","label":"Priority Field","type":"string"}]</option_schema>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
	/* populate the 'data' object */
	/* e.g., data.table = $sp.getValue('table'); */

	if (options.table) {
		data.filterModal = $sp.getWidget('widget-modal', {'embeddedWidgetId': 'sn-desktop-filter', 'embeddedWidgetOptions': { table: options.table, initialQuery: options.filter }});
		data.cardFields = $sp.getListColumns(options.table, options.view_dv);
		data.rows = [];
		var gr = new GlideRecord(options.table);
		gr.addEncodedQuery(options.filter);
		gr.setLimit(25);
		gr.query();
		if (!data.primaryField) {
				data.primaryField = gr.getDisplayName();
			}
		var fields = "sys_id," + data.primaryField + "," + data.cardFields;
		data.fields = $sp.getFieldsObject(gr, fields);
		while(gr.next()) {
			var row = {};
			$sp.getRecordDisplayValues(row, gr, fields);
			data.rows.push(row);
		}
	}
	
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2017-04-30 14:47:07</sys_created_on>
        <sys_id>832d5488f4ae32007f44717f642a228d</sys_id>
        <sys_mod_count>61</sys_mod_count>
        <sys_name>Card List</sys_name>
        <sys_package display_value="Reusable Widgets" source="x_snc_reusable_wid">cbefa4faf41232007f44717f642a22b4</sys_package>
        <sys_policy/>
        <sys_scope display_value="Reusable Widgets">cbefa4faf41232007f44717f642a22b4</sys_scope>
        <sys_update_name>sp_widget_832d5488f4ae32007f44717f642a228d</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2017-05-04 20:36:23</sys_updated_on>
        <template><![CDATA[<div>
  <sp-widget widget="c.filterModal" ng-if="c.filterModal"></sp-widget>
  <div class="panel panel-default">
    <div class="panel-heading">
      <a href="javascript:void(0)" ng-click="c.showFilter($event)" class="pull-right"><span class="glyphicon glyphicon-search"></span></a> <span class="h3 panel-title">{{::c.options.title}}</span>
    </div>
    <div class="panel-body">
      <workspace-card ng-repeat="row in c.data.rows track by row.sys_id"
                      row="::row" 
                      primary-field="::c.data.primaryField"
                      display-field="::c.options.display_field"
                      priority-field="::c.options.priority_field"
                      fields="::c.data.fields"
                      card-fields="::c.cardFields"></workspace-card>
    </div>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
